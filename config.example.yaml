# Syslog Forwarder Configuration
# ================================
# Copy this file to config.yaml and customize for your environment.

version: "1"

# Input listeners
# ---------------
# Define where to receive syslog messages.
# Supported protocols: udp, tcp (tls coming in Phase 2)
inputs:
  - name: udp-514
    protocol: udp
    address: "0.0.0.0:514"

  - name: tcp-514
    protocol: tcp
    address: "0.0.0.0:514"

# Message transformations
# -----------------------
# Define reusable transformations to modify messages before forwarding.
transforms:
  # Remove process ID from messages
  - name: remove-pid
    remove_fields: [proc_id]

  # Anonymize IP addresses
  - name: anonymize-ip
    mask_patterns:
      - pattern: "\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b"
        replacement: "x.x.x.x"

  # Mask sensitive data (passwords, tokens)
  - name: mask-secrets
    mask_patterns:
      - pattern: "(password|passwd|pwd|secret|token|api_key)[\\s]*[=:][\\s]*['\"]?([^'\"\\s]+)['\"]?"
        replacement: "\\1=***REDACTED***"
      - pattern: "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b"
        replacement: "***@***.***"

  # Rewrite hostname
  - name: set-hostname
    set_fields:
      hostname: "forwarded-logs"

  # Clean up message content
  - name: cleanup-message
    message_replace:
      pattern: "\\s+"
      replacement: " "
    remove_fields: [structured_data]

# Filter rules
# ------------
# Rules are evaluated in order. First match wins.
# Each filter can forward to destinations and optionally apply transforms.
filters:
  # Example: Forward auth/security logs to SIEM with IP anonymization
  - name: security-logs
    match:
      facility: [auth, authpriv]
      severity: [warning, err, crit, alert, emerg]
    transforms: [mask-secrets, anonymize-ip]
    destinations: [siem]

  # Example: Forward critical errors to alerting system
  - name: critical-alerts
    match:
      severity: [crit, alert, emerg]
    destinations: [siem, pagerduty]

  # Example: Drop debug messages
  - name: drop-debug
    match:
      severity: [debug]
    action: drop

  # Example: Forward everything else with cleanup
  - name: default
    transforms: [remove-pid, cleanup-message]
    destinations: [central]

# Destinations
# ------------
# Define where to forward messages.
# Supported protocols: udp, tcp (tls coming in Phase 2)
# Supported formats: rfc3164 (BSD), rfc5424 (modern), auto (preserve original)
destinations:
  - name: siem
    protocol: tcp
    address: "siem.example.com:514"
    format: rfc5424
    retry:
      max_attempts: 3
      backoff_seconds: 1.0

  - name: pagerduty
    protocol: tcp
    address: "events.pagerduty.com:514"
    format: rfc5424

  - name: central
    protocol: udp
    address: "logs.example.com:514"
    format: rfc3164

# Service settings
# ----------------
service:
  # Logging level: debug, info, warning, error
  log_level: info

  # Prometheus metrics endpoint
  metrics:
    enabled: true
    address: "0.0.0.0:9090"

# Environment variable substitution
# ---------------------------------
# You can use ${VAR} or ${VAR:-default} syntax:
#
#   address: "${SIEM_HOST:-siem.example.com}:514"
#   address: "${LOG_SERVER}:${LOG_PORT:-514}"
